<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="朝闻道 夕死可矣">
<meta property="og:type" content="website">
<meta property="og:title" content="WYY's Blog">
<meta property="og:url" content="http://wu-yuanyi.github.io/page/2/index.html">
<meta property="og:site_name" content="WYY's Blog">
<meta property="og:description" content="朝闻道 夕死可矣">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="WYY's Blog">
<meta name="twitter:description" content="朝闻道 夕死可矣">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://wu-yuanyi.github.io/page/2/"/>





  <title>WYY's Blog</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">WYY's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">JUST DO IT</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wu-yuanyi.github.io/2018/09/25/Database/HiveQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuanyi Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WYY's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/25/Database/HiveQL/" itemprop="url">Untitled</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-25T15:57:20+08:00">
                2018-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Database/" itemprop="url" rel="index">
                    <span itemprop="name">Database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Data-Types"><a href="#Data-Types" class="headerlink" title="Data Types"></a>Data Types</h1><h2 id="Column-Types"><a href="#Column-Types" class="headerlink" title="Column Types"></a>Column Types</h2><h3 id="Timestamps"><a href="#Timestamps" class="headerlink" title="Timestamps"></a>Timestamps</h3><p>Timestamps are interpreted to be timezoneless and stored as an offset from the UNIX epoch.</p>
<p>Supported conversions:</p>
<ul>
<li>Integer numeric types: Interpreted as UNIX timestamp in seconds</li>
<li>Floating point numeric types: Interpreted as UNIX timestamp in seconds with decimal precision</li>
<li>Strings: JDBC compliant java.sql.Timestamp format <code>YYYY-MM-DD HH:MM:SS.fffffffff</code> (9 decimal place precision)</li>
</ul>
<h3 id="Dates"><a href="#Dates" class="headerlink" title="Dates"></a>Dates</h3><p>Date values describe a particular year/month/day, in the form <code>YYYY-­MM-­DD</code>. The range of values supported for the Date type is 0000-­01-­01 to 9999-­12-­31.</p>
<ul>
<li>cast(timestamp as date): The year/month/day of the timestamp is determined, based on the local timezone, and returned as a date value.</li>
<li>cast(string as date): If the string is in the form <code>YYYY-MM-DD</code>, then a date value corresponding to that year/month/day is returned. If the string value does not match this formate, then NULL is returned.</li>
</ul>
<h3 id="Union-Types"><a href="#Union-Types" class="headerlink" title="Union Types"></a>Union Types</h3><p>The first part in the deserialized union is the <em>tag</em> which lets us know which part of the union is being used. In this example <code>0</code> means the first data_type from the definition which is an <code>int</code> and so on.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE union_test(foo UNIONTYPE&lt;int, double, array&lt;string&gt;, struct&lt;a:int,b:string&gt;&gt;);</div><div class="line">SELECT foo FROM union_test;</div><div class="line"></div><div class="line">&#123;0:1&#125;</div><div class="line">&#123;1:2.0&#125;</div><div class="line">&#123;2:["three","four"]&#125;</div><div class="line">&#123;3:&#123;"a":5,"b":"five"&#125;&#125;</div><div class="line">&#123;2:["six","seven"]&#125;</div><div class="line">&#123;3:&#123;"a":8,"b":"eight"&#125;&#125;</div><div class="line">&#123;0:9&#125;</div><div class="line">&#123;1:10.0&#125;</div></pre></td></tr></table></figure>
<p>To create a union you have to provide this tag to the <code>create_union</code> UDF:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">SELECT create_union(0, key), create_union(if(key&lt;100, 0, 1), 2.0, value), create_union(1, "a", struct(2, "b")) FROM src LIMIT 2;</div><div class="line"></div><div class="line">&#123;0:"238"&#125;	&#123;1:"val_238"&#125;	&#123;1:&#123;"col1":2,"col2":"b"&#125;&#125;</div><div class="line">&#123;0:"86"&#125;	&#123;0:2.0&#125;	&#123;1:&#123;"col1":2,"col2":"b"&#125;&#125;</div></pre></td></tr></table></figure>
<h2 id="Literals"><a href="#Literals" class="headerlink" title="Literals"></a>Literals</h2><h3 id="Floating-Point-Types"><a href="#Floating-Point-Types" class="headerlink" title="Floating Point Types"></a>Floating Point Types</h3><p>Decimal literals provide precise values and greater range for floating point numbers than the DOUBLE type. Decimal types are needed for use cases in which the (very close) approximation of a DOUBLE is insufficient, such as financial applications, equality and inequality checks, and rounding operations.</p>
<h1 id="Date-Definition-Statements"><a href="#Date-Definition-Statements" class="headerlink" title="Date Definition Statements"></a>Date Definition Statements</h1><h2 id="Create-Drop-Truncate-Table"><a href="#Create-Drop-Truncate-Table" class="headerlink" title="Create/Drop/Truncate Table"></a>Create/Drop/Truncate Table</h2><h3 id="Managed-and-External-Tables"><a href="#Managed-and-External-Tables" class="headerlink" title="Managed and External Tables"></a>Managed and External Tables</h3><ul>
<li><p>Use managed tables when Hive should manage the lifecycle of the table, or when generating temporary tables.</p>
</li>
<li><p>External table files can be accessed and managed by processes outside of Hive.</p>
</li>
</ul>
<p>If a managed table or partition is dropped, the data and metadata associated with that table or partition are deleted. If the PURGE option is not specified, the data is moved to a trash folder for a defined duration.</p>
<h3 id="CTSAS"><a href="#CTSAS" class="headerlink" title="CTSAS"></a>CTSAS</h3><p>CTAS(create table as select) has these restrictions:</p>
<ul>
<li>The target table cannot be a partitioned table.</li>
<li>The target table cannot be an external table.</li>
<li>The target table cannot be a list bucketing table.</li>
</ul>
<p>##Macro and Function</p>
<h3 id="Create-Drop-Temporary-Macro"><a href="#Create-Drop-Temporary-Macro" class="headerlink" title="Create/Drop Temporary Macro"></a>Create/Drop Temporary Macro</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TEMPORARY</span> MACRO macro_name([col_name col_type, ...]) expression;</div><div class="line"></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TEMPORARY</span> MACRO fixed_number() <span class="number">42</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TEMPORARY</span> MACRO string_len_plus_two (x <span class="keyword">string</span>) <span class="keyword">length</span>(x) + <span class="number">2</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TEMPORARY</span> MACRO simple_add (x <span class="built_in">int</span>, y <span class="built_in">int</span>) x + y;</div><div class="line"></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TEMPORARY</span> MACRO [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] macro_name;</div></pre></td></tr></table></figure>
<h3 id="Temporary-Functions"><a href="#Temporary-Functions" class="headerlink" title="Temporary Functions"></a>Temporary Functions</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TEMPORARY</span> <span class="keyword">FUNCTION</span> function_name <span class="keyword">AS</span> class_name;</div><div class="line"></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TEMPORARY</span> <span class="keyword">FUNCTION</span> [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] function_name;</div><div class="line"></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> [db_name.]function_name <span class="keyword">AS</span> class_name [<span class="keyword">USING</span> JAR|<span class="keyword">FILE</span>|<span class="keyword">ARCHIVE</span> <span class="string">'file_uri'</span> [, JAR|<span class="keyword">FILE</span>|<span class="keyword">ARCHIVE</span> <span class="string">'file_uri'</span>] ];</div></pre></td></tr></table></figure>
<h2 id="Data-Retrieval-Queries"><a href="#Data-Retrieval-Queries" class="headerlink" title="Data Retrieval: Queries"></a>Data Retrieval: Queries</h2><h3 id="HAVING-Clause"><a href="#HAVING-Clause" class="headerlink" title="HAVING Clause"></a>HAVING Clause</h3><p>The <figure class="highlight plain"><figcaption><span>clause was added to SQL because the ```WHERE``` keyword could not be used with aggregate functions.</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">```WHERE``` works before return result, ```HAVING``` filter the result returned by query.</div><div class="line"></div><div class="line">```sql</div><div class="line">select col1 from t1 group by col1 having sum(col2) &gt; 10;</div><div class="line">select col1 from (select col1, sum(col2) as col2sum from t1 group by col1) t2 where t2.col2sum &gt; 10;</div></pre></td></tr></table></figure></p>
<h3 id="LIMIT-Clause"><a href="#LIMIT-Clause" class="headerlink" title="LIMIT Clause"></a>LIMIT Clause</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> customers <span class="keyword">limit</span> <span class="number">5</span>;</div><div class="line"><span class="comment">--The previous query returns 5 arbitrary customers</span></div><div class="line"></div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> customers <span class="keyword">order</span> <span class="keyword">by</span> create_date <span class="keyword">limit</span> <span class="number">5</span>;</div><div class="line"><span class="comment">--The previous query returns the first 5 customers to be created</span></div><div class="line"></div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> customers <span class="keyword">order</span> <span class="keyword">by</span> create_date <span class="keyword">limit</span> <span class="number">2</span>,<span class="number">5</span>;</div><div class="line"><span class="comment">--The previous query returns the  3rd to the 7th customers to be created</span></div></pre></td></tr></table></figure>
<h3 id="REGEX-Column-Specification"><a href="#REGEX-Column-Specification" class="headerlink" title="REGEX Column Specification"></a>REGEX Column Specification</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> hive.support.quoted.identifiers=<span class="keyword">none</span>;</div><div class="line"><span class="comment">--The following query selects all columns except ds and hr.</span></div><div class="line"><span class="keyword">SELECT</span> <span class="string">`(ds|hr)?+.+`</span> <span class="keyword">FROM</span> sales;</div></pre></td></tr></table></figure>
<h3 id="GROUP-BY"><a href="#GROUP-BY" class="headerlink" title="GROUP BY"></a>GROUP BY</h3><p>Multiple aggregations can be done at the same time, however, no two aggregations can have different DISTINCT columns. </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> users.gender, <span class="keyword">count</span>(<span class="keyword">distinct</span> users.userid), <span class="keyword">count</span>(*), <span class="keyword">sum</span>(<span class="keyword">distinct</span> users.userid) <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">group</span> <span class="keyword">by</span> users.gender;</div></pre></td></tr></table></figure>
<p>When using group by clause, the select statement can only include columns included in the group by clause. Of course, you can have as many aggregation functions in the select statement as well.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> a, <span class="keyword">sum</span>(b) <span class="keyword">from</span> t1 <span class="keyword">group</span> <span class="keyword">by</span> a;</div></pre></td></tr></table></figure>
<p><em>hive.map.aggr</em> controls how we do aggregations. The default is false. If it is set to true, Hive will do the first-level aggregation directly in the map task. This usually provides better efficiency, but may require more memory to run successfully.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> hive.map.aggr=<span class="literal">true</span>;</div><div class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> table2;</div></pre></td></tr></table></figure>
<h3 id="Order-Sort-Distribute-Cluster-By"><a href="#Order-Sort-Distribute-Cluster-By" class="headerlink" title="Order/Sort/Distribute/Cluster By"></a>Order/Sort/Distribute/Cluster By</h3><p>There are some limitations in the <figure class="highlight plain"><figcaption><span>by``` clause. In the strict mode (i.e., ``` set hive.mapred.mode=strict```), the order by clause has to be followed by a ```limit``` clause. The reason is that in order to impose total order of all results, there has to be one reducer to sort the final output. If the number of rows in the output is too large, the single reducer could take a very long time to finish.</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">```sql</div><div class="line">order by colName (asc|desc) (nulls first|last) (, (asc|desc) (nulls first|last))</div></pre></td></tr></table></figure></p>
<p>The difference between <figure class="highlight plain"><figcaption><span>by``` and ```sort by``` is that the former guarantees total order in the output while the latter only guarantees ordering of the rows within a reducer. If there are more than one reducer, ```sort by``` may give partially ordered final results. The difference between ```sort by``` alone of a single column and ```cluster by``` is that ```cluster by``` partitions by the field and ```sort by``` if there are multiple reducers partitions randomly in order to distribute data (and load) uniformly across the reducers.</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">```sql</div><div class="line">select key, value from src sort by key asc, value desc;</div></pre></td></tr></table></figure></p>
<p><code>cluster By</code> is a short-cut for both <code>distribute By</code> and <code>sort By</code>.</p>
<h3 id="Operators-and-UDFS"><a href="#Operators-and-UDFS" class="headerlink" title="Operators and UDFS"></a>Operators and UDFS</h3><ul>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-RelationalOperators" target="_blank" rel="external">Relational Operators</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-ArithmeticOperators" target="_blank" rel="external">Arithmetic Operators</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-LogicalOperators" target="_blank" rel="external">Logical Operators</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-StringOperators" target="_blank" rel="external">String Operators</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-MathematicalFunctions" target="_blank" rel="external">Mathematical Functions</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-CollectionFunctions" target="_blank" rel="external">Collection Functions</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-TypeConversionFunctions" target="_blank" rel="external">Type Conversion Functions</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-DateFunctions" target="_blank" rel="external">Date Functions</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-ConditionalFunctions" target="_blank" rel="external">Conditional Functions</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-StringFunctions" target="_blank" rel="external">String Functions</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-DataMaskingFunctions" target="_blank" rel="external">Data Masking Functions</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wu-yuanyi.github.io/2018/04/17/DataAnalysis/风控建模/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuanyi Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WYY's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/17/DataAnalysis/风控建模/" itemprop="url">风控建模</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-17T16:32:16+08:00">
                2018-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Data-Analysis/" itemprop="url" rel="index">
                    <span itemprop="name">Data Analysis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="模型评估指标"><a href="#模型评估指标" class="headerlink" title="模型评估指标"></a>模型评估指标</h2><h3 id="混淆矩阵-Confusion-matrix"><a href="#混淆矩阵-Confusion-matrix" class="headerlink" title="混淆矩阵 Confusion matrix"></a>混淆矩阵 Confusion matrix</h3><table>
<thead>
<tr>
<th></th>
<th>预测1</th>
<th>预测0</th>
<th>合计</th>
</tr>
</thead>
<tbody>
<tr>
<td>实际1</td>
<td>TP(True Positive)</td>
<td>FN(False Negative)</td>
<td>Actual Positive</td>
</tr>
<tr>
<td>实际0</td>
<td>FP(False Positive)</td>
<td>TN(True Negative)</td>
<td>Actual Negative</td>
</tr>
<tr>
<td>合计</td>
<td>Predicted Positive</td>
<td>Predicted Negative</td>
<td>All</td>
</tr>
</tbody>
</table>
<ul>
<li>Recall(召回率), Sensitivity(敏感性): TP / (TP + FN)</li>
<li>Precision(精确率): TP / (TP + FP)</li>
<li>Specificity(特异性): TN / (TN + FP)</li>
<li>Accuracy(准确率): (TP + TN) / (TP + FP + FN + TN)</li>
<li>F值：F-measure = 2 <em> (Recall </em> Precision) / (Recall + Precision)<ul>
<li>加权调和平均数，假设Precision和Recall同样重要</li>
</ul>
</li>
</ul>
<h3 id="ROC和AUC"><a href="#ROC和AUC" class="headerlink" title="ROC和AUC"></a>ROC和AUC</h3><p>ROC（Receiver Operating Characteristic）曲线和AUC（Area Under Curve）常被用来评价一个二值分类器（binary classifier）的优劣。</p>
<h4 id="ROC"><a href="#ROC" class="headerlink" title="ROC"></a>ROC</h4><p>ROC曲线的横坐标为false positive rate（FPR），纵坐标为true positive rate（TPR）。</p>
<p>FPR = 1- Specificity = FP / N = FP / (TN + FP)</p>
<p>TPR = Recall = Sensitivity = TP / P = TP / (TP + FN)</p>
<p><img src="/2018/04/17/DataAnalysis/风控建模/roc_curves.png" alt="roc_curve"></p>
<ul>
<li>(0,1)：FPR=0，TPR=1，即FP和FN都为0，所有分类都正确。</li>
<li>(1,0)：FPR=1，TPR=0，即FP和FN都为1，所有分类都错误。</li>
<li>(0,0)：FPR=0，TPR=0，即FP为0，FN为1，所有分类预测为负样本。</li>
<li>(1,1)：FPR=1，TPR=1，即FP为1，FN为0，所有分类预测为正样本。</li>
<li>y=x线上：采用随机分类的分类器。</li>
<li>ROC曲线越接近左上角，该分类器性能越好。</li>
</ul>
<p>ROC曲线的优点：当测试集中的正负样本的分布变化的时候，ROC曲线能够保持不变。在实际的数据集中经常会出现类不平衡（class imbalance）现象，即负样本比正样本多很多（或者相反），而且测试数据中的正负样本的分布也可能随着时间变化。</p>
<h4 id="AUC"><a href="#AUC" class="headerlink" title="AUC"></a>AUC</h4><p>AUC（Area Under Curve）被定义为ROC曲线下的面积。由于ROC曲线一般都处于y=x这条直线的上方，所以AUC的取值范围在0.5和1之间。</p>
<blockquote>
<p>The AUC value is equivalent to the probability that a randomly chosen positive example is ranked higher than a randomly chosen negative example.</p>
</blockquote>
<p>AUC值越大，当前分类算法越可能将正样本排在负样本之前，即能更好的分类。</p>
<h3 id="Lift"><a href="#Lift" class="headerlink" title="Lift"></a>Lift</h3><p>Lift = [TP/(TP+FP)] / [(TP+FN)/(TP + FP + TN + FN)]</p>
<p>用于衡量与不利用模型相比，模型预测能力的提升度。Lift越大，模型效果越好。</p>
<p>在不使用模型时（baseline model），需要在整个样本中挑选，挑选的准确率是(TP+FN)/(TP + FP + TN + FN)。</p>
<p>在使用模型时，，只在预测为positive的样例中挑选，挑选的准确率是TP/(TP+FP)。<img src="/2018/04/17/DataAnalysis/风控建模/lift.png" alt="lift"></p>
<p>当阈值越大，越少的观测值会归为正例，但这部分越具有正例特征（以银行向客户推荐信用卡的例子来看，这一部分人群对推荐的反应最为活跃），所以在这个设置下，对应的lift值最大。当阈值越小，越多的观测值会归为正例，这时分类的效果就跟baseline model差不多了，相对应的lift值就接近于1。</p>
<h3 id="Gain"><a href="#Gain" class="headerlink" title="Gain"></a>Gain</h3><p>增益图与提升图的区别在于纵坐标。它的纵坐标是TP/(TP+FP)。</p>
<p>增益图是描述整体精准率的指标。按照模型预测出的概率从高到低排列，将每一个百分位数内的精准率指标标注在图形区域内，就形成了非累积的增益图。如果对每一个百分位及其之前的精准率求和，并将值标注在图形区域内，则形成累积的增益图。</p>
<p><img src="/2018/04/17/DataAnalysis/风控建模/gain.png" alt="201800426gain"></p>
<h3 id="K-S"><a href="#K-S" class="headerlink" title="K-S"></a>K-S</h3><p>正样本洛伦兹曲线记为f(x)，负样本洛伦兹曲线记为g(x)，K-S曲线实际上是f(x)与g(x)的差值曲线。K-S曲线的最高点（最大值）定义为KS值，KS值越大，模型分值的区分度越好，KS值为0代表是最没有区分度的随机模型。准确的来说，K-S是用来度量阳性与阴性分类区分程度的。</p>
<p>K-S曲线的纵坐标是TPR与FPR。</p>
<p><img src="/2018/04/17/DataAnalysis/风控建模/k-s.png" alt="20180426k-s"></p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://alexkong.net/2013/06/introduction-to-auc-and-roc/" target="_blank" rel="external">ROC和AUC介绍以及如何计算AUC</a></p>
<p><a href="https://www.jianshu.com/p/6ffa3df3ec86" target="_blank" rel="external">如何评估一个机器学习模型</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wu-yuanyi.github.io/2018/03/20/Loan/人行报告(详版)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuanyi Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WYY's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/20/Loan/人行报告(详版)/" itemprop="url">人行报告专业版</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-20T11:05:28+08:00">
                2018-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Loan/" itemprop="url" rel="index">
                    <span itemprop="name">Loan</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="样本"><a href="#样本" class="headerlink" title="样本"></a>样本</h1><p><a href="https://wenku.baidu.com/view/81a23a7e6bec0975f565e2c9.html?re=view" target="_blank" rel="external">个人信用报告（银行专业版）样本</a></p>
<h1 id="基础信息"><a href="#基础信息" class="headerlink" title="基础信息"></a>基础信息</h1><ul>
<li>查询时间：央行系统收到查申请人提出查询申请的时间</li>
<li>报告时间：系统收到查询申请后，生成查询人的信用报告的时间</li>
<li>账户数：名下分别有几个信用卡账户、几笔住房贷款、几笔其他贷款</li>
<li>未销户账户数：查询人名下未销户（含正在使用和尚未激活）的信用卡账户数量</li>
<li>未结清账户数：查询人名下未结清住房贷款和其他贷款的账户数量</li>
<li>透支余额：准贷记卡欠银行钱的数量（包含本金和利息）</li>
<li>已使用额度：贷记卡欠银行钱的数量（包含本金和利息）</li>
<li>逾期金额：截至还款日的最后期限，仍未按时或足额偿还的金额，以及由此产生的利息（含罚息）和费用（包括超限费和滞纳金）</li>
<li>公共记录：含最近5年内的欠税记录、法院民事判决记录、强制执行记录、行政处罚记录、电信欠费记录</li>
<li>查询记录：何机构或何人在何时以何种理由查询过此人的信用报告</li>
</ul>
<h1 id="进阶信息"><a href="#进阶信息" class="headerlink" title="进阶信息"></a>进阶信息</h1><h2 id="账户数"><a href="#账户数" class="headerlink" title="账户数"></a>账户数</h2><p>账户数不等同于信用卡张数，而是等于信用卡记录数</p>
<h3 id="同币种信用卡合并显示"><a href="#同币种信用卡合并显示" class="headerlink" title="同币种信用卡合并显示"></a>同币种信用卡合并显示</h3><p>民生银行（持有十张卡）</p>
<ul>
<li>都是人民币账户：信用报告上显示1条关于民生银行信用卡的记录</li>
<li>都是双币账户：信用报告上显示2条关于民生银行信用卡的记录</li>
<li>都是N币账户：信用报告上显示N条关于民生银行信用卡的记录</li>
</ul>
<h3 id="同币种信用卡不合并显示"><a href="#同币种信用卡不合并显示" class="headerlink" title="同币种信用卡不合并显示"></a>同币种信用卡不合并显示</h3><p>工商银行（持有十张卡）：</p>
<ul>
<li>都是人民币账户：信用报告上显示10条关于工商银行信用卡的记录</li>
<li>都是双币账户：信用报告上显示20条关于工商银行信用卡的记录</li>
<li>都是N币账户：信用报告上显示N0条关于工商银行信用卡的记录</li>
</ul>
<h3 id="合并账单"><a href="#合并账单" class="headerlink" title="合并账单"></a>合并账单</h3><p>广发银行（持有十张卡）：</p>
<p>显示为1条信用记录，包含10张卡的消费记录，10张卡的账单日和还款日一致</p>
<h3 id="不合并账单"><a href="#不合并账单" class="headerlink" title="不合并账单"></a>不合并账单</h3><p>中国银行（持有十张卡）：</p>
<p>显示为10条信用记录，每条包含1张卡的消费记录，10张卡的账单日和还款日可以不一致</p>
<h3 id="还款不需要每张卡分别还"><a href="#还款不需要每张卡分别还" class="headerlink" title="还款不需要每张卡分别还"></a>还款不需要每张卡分别还</h3><p>浦发银行（持有十张卡）：</p>
<p>还款只需要还其中1张即可，还清了其中1张卡的账单，即还清所有卡的账单了。</p>
<p>###还款需要每张卡分别还 </p>
<p>农业银行（持有十张卡）：</p>
<p>还款需要还每一张的信用卡，把每一张信用卡的账单都还清，才还清所有卡的账单。</p>
<h2 id="报告的延迟性"><a href="#报告的延迟性" class="headerlink" title="报告的延迟性"></a>报告的延迟性</h2><ul>
<li>如果某人申请了新的信用卡，或者办理了新的贷款，信报上并不会第一时间显示出查询记录、信用卡记录、贷款记录</li>
<li>信用卡的已使用额度和账单并不是实时的，一般银行会每一个月或者每两个月上报数据，也就意味着个人征信报告的信用卡数据一般一到两个月更新一次。</li>
<li>银行贷款和其他贷款机构的贷款记录一般会在1个星期甚至1个月以上的时间才会上报，并在信报上体现出来。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wu-yuanyi.github.io/2017/11/21/Loan/地址清洗/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuanyi Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WYY's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/11/21/Loan/地址清洗/" itemprop="url">中文地址清洗</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-11-21T13:50:20+08:00">
                2017-11-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Loan/" itemprop="url" rel="index">
                    <span itemprop="name">Loan</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="中文分词的基本原则"><a href="#中文分词的基本原则" class="headerlink" title="中文分词的基本原则"></a>中文分词的基本原则</h2><ul>
<li>颗粒度越大越好</li>
</ul>
<p>分词结果的颗粒度越大（即单词的字数越多），所能表示的含义越确切。如：“公安局长”可以分为“公安 局长”、“公安局 长”、“公安局长”，但是要用于语义分析，则“公安局长”的分词结果最好（前提是所使用的词典中有这个词）。</p>
<ul>
<li>切分结果中非词典词越少越好，单字词典词数越少越好<ul>
<li>非词典词：不包含在词典中的单字</li>
<li>单字词典词：可以独立运用的单字，如：的、了、和、你、我、他</li>
</ul>
</li>
</ul>
<p>如：“技术和服务”，可以分为“技术 和服 务”以及“技术 和 服务”。“务”字无法独立成词（即词典中没有），但“和”字可以单独成词（词典中要包含），因此“技术 和服 务”有1个非词典词，而“技术 和 服务”有0个非词典词，因此选用后者。</p>
<ul>
<li>总体词数越少越好</li>
</ul>
<p>在相同字数的情况下，总词数越少，说明语义单元越少，那么相对的单个语义单元的权重会越大，因此准确性会越高。</p>
<h2 id="匹配算法"><a href="#匹配算法" class="headerlink" title="匹配算法"></a>匹配算法</h2><h3 id="最大匹配算法"><a href="#最大匹配算法" class="headerlink" title="最大匹配算法"></a>最大匹配算法</h3><p>最大匹配是指以词典为依据，取词典中最长单词为第一个次取字数量的扫描串，在词典中进行扫描（为提升扫描效率，还可以跟据字数多少设计多个字典，然后根据字数分别从不同字典中进行扫描）。例如：词典中最长词为“中华人民共和国”共7个汉字，则最大匹配起始字数为7个汉字。然后逐字递减，在对应的词典中进行查找。</p>
<h3 id="正向最大匹配算法"><a href="#正向最大匹配算法" class="headerlink" title="正向最大匹配算法"></a>正向最大匹配算法</h3><p>以“我们在野生动物园”为例，词典中最长词为“中华人民共和国”。</p>
<p>正向即从前往后取词，从7-&gt;1，每次减一个字，直到词典命中或剩下1个单字。</p>
<p>第1轮第1次：7字词典中扫描“我们在野生动物”，无；</p>
<p>第1轮第2次：6字词典中扫描“我们在野生动”，无；</p>
<p>第1轮第3次：5字词典中扫描“我们在野生”，无；</p>
<p>第1轮第4次：4字词典中扫描“我们在野”，无；</p>
<p>第1轮第5次：3字词典中扫描“我们在”，无；</p>
<p>第1轮第6次：2字词典中扫描“我们”，有；</p>
<p>扫描中止，输出第1个词为“我们”，去除第1个词后开始第2轮扫描。</p>
<p>第2轮第1次：7字词典中扫描“在野生动物园玩”，无；</p>
<p>第2轮第2次：6字词典中扫描“在野生动物园”，无；</p>
<p>第2轮第3次：5字词典中扫描“在野生动物”，无；</p>
<p>第2轮第4次：4字词典中扫描“在野生动”，无；</p>
<p>第2轮第5次：3字词典中扫描“在野生”，无；</p>
<p>第2轮第6次：2字词典中扫描“在野”，有；</p>
<p>扫描中止，输出第2个词为“在野”，去除第2个词后开始第3轮扫描。</p>
<p>第3轮第1次：5字词典中扫描“生动物园玩”，无；</p>
<p>第3轮第2次：4字词典中扫描“生动物园”，无；</p>
<p>第3轮第3次：3字词典中扫描“生动物”，无；</p>
<p>第3轮第4次：2字词典中扫描“生动”，有；</p>
<p>扫描中止，输出第3个词为“生动”，去除第3个词后开始第4轮扫描。</p>
<p>第4轮第1次：3字词典中扫描“物园玩”，无；</p>
<p>第4轮第2次：2字词典中扫描“物园”，无；</p>
<p>第4轮第3次：1字词典中扫描“物”，无；</p>
<p>扫描中止，输出第4个词为“物”，非词典词数加1，去除第4个词后开始第5轮扫描。</p>
<p>第5轮第1次：2字词典中扫描“园玩”，无；</p>
<p>第5轮第2次：1字词典中扫描“园”，有；</p>
<p>扫描中止，输出第5个词为“园”，单字词典词数加1，去除第5个词后开始第6轮扫描。</p>
<p>第6轮第1次：1字词典中扫描“玩”，有；</p>
<p>扫描中止，输出第6个词为“园”，单字词典词数加1，扫描结束。</p>
<p>最终切分结果为：“我们/在野/生动/物/园/玩”，其中，单字词典词数为2，非词典词数为1。</p>
<h3 id="逆向最大匹配算法"><a href="#逆向最大匹配算法" class="headerlink" title="逆向最大匹配算法"></a>逆向最大匹配算法</h3><p>以“我们在野生动物园”为例，词典中最长词为“中华人民共和国”。</p>
<p>逆向即从后往前取词，从7-&gt;1，每次减一个字，直到词典命中或剩下1个单字。</p>
<p>第1轮第1次：7字词典中扫描“在野生动物园玩”，无；</p>
<p>第1轮第2次：6字词典中扫描“野生动物园玩”，无；</p>
<p>第1轮第3次：5字词典中扫描“生动物园玩”，无；</p>
<p>第1轮第4次：4字词典中扫描“动物园玩”，无；</p>
<p>第1轮第5次：3字词典中扫描“物园玩”，无；</p>
<p>第1轮第6次：2字词典中扫描“园玩”，无；</p>
<p>第1轮第7次：1字词典中扫描“玩”，有；</p>
<p>扫描中止，输出第1个词为“玩”，单字词典词数加1，去除第1个词后开始第2轮扫描。</p>
<p>第2轮第1次：7字词典中扫描“们在野生动物园”，无；</p>
<p>第2轮第2次：6字词典中扫描“在野生动物园”，无；</p>
<p>第2轮第3次：5字词典中扫描“野生动物园”，有；</p>
<p>扫描中止，输出第2个词为“动物”，去除第2个词后开始第3轮扫描。</p>
<p>第3轮第1次：3字词典中扫描“我们在”，无；</p>
<p>第3轮第2次：2字词典中扫描“们在”，无；</p>
<p>第3轮第3次：1字词典中扫描“在”，有；</p>
<p>扫描中止，输出第3个词为“玩”，单字词典词数加1，去除第3个词后开始第4轮扫描。</p>
<p>第4轮第1次：2字词典中扫描“我们”，有；</p>
<p>扫描中止，输出第4个词为“我们”，扫描结束。</p>
<p>最终切分结果为：“我们/在/野生动物园/玩”，其中，单字词典词数为2，非词典词数为0。</p>
<h3 id="双向最大匹配算法"><a href="#双向最大匹配算法" class="headerlink" title="双向最大匹配算法"></a>双向最大匹配算法</h3><p>正向、逆向两种算法都切一遍，然后根据大颗粒度词越多越好，非词典词和单字词越少越好的原则，选取其中一种分词结果输出。</p>
<ul>
<li>非词典词数：越少越好</li>
<li>单字词典词数：越少越好</li>
<li>总词数：越少越好</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://wu-yuanyi.github.io/2017/09/25/SAS/SAS编程演义9-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yuanyi Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WYY's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/25/SAS/SAS编程演义9-10/" itemprop="url">《SAS编程演义》笔记（9-10章）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-25T11:09:39+08:00">
                2017-09-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SAS/" itemprop="url" rel="index">
                    <span itemprop="name">SAS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="拙中藏巧混天成：统计表格"><a href="#拙中藏巧混天成：统计表格" class="headerlink" title="拙中藏巧混天成：统计表格"></a>拙中藏巧混天成：统计表格</h2><h3 id="医药科研"><a href="#医药科研" class="headerlink" title="医药科研"></a>医药科研</h3><ul>
<li>基线信息表格：介绍人群基本情况</li>
<li>危险因素表格：会在表格中给出事件频数和百分比、粗的效应值及其95%CI和P值</li>
<li>结局效应表格：横款目为终点指标，纵款目除了分组信息，还有效应量</li>
<li>亚组分析表格：最重要的信息是需要提供交互作用校验的结果，通常以森林图的形式展示</li>
</ul>
<h3 id="统计汇总过程"><a href="#统计汇总过程" class="headerlink" title="统计汇总过程"></a>统计汇总过程</h3><p>一个统计过程中只能获得一种变量（分类、连续）的统计数据，款目形式不便统一。</p>
<ul>
<li>RTF（Rich Text File）可直接用Word打开编辑</li>
<li>journal3a是最贴近三线表的样式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ods tagsets.rtf file=&quot;table.rtf&quot; style=journal3a; /**/</div><div class="line">proc freq data=sashelp.heart;</div><div class="line">    table bp_status*sex / nopercent norow;</div><div class="line">run;</div><div class="line">ods tagsets.rtf close;</div><div class="line"></div><div class="line">ods tagsets.etf file=&quot;table2.rtf&quot; style=journal3a;</div><div class="line">proc means data=sashelp.heart mean std maxdec=2;</div><div class="line">    class sex;</div><div class="line">    var height;</div><div class="line">run;</div><div class="line">ods tagsets.rtf close;</div></pre></td></tr></table></figure>
<h3 id="PROC-TABULATE"><a href="#PROC-TABULATE" class="headerlink" title="PROC TABULATE"></a>PROC TABULATE</h3><p>能一次性实现多种变量的统计需求，也能比较灵活的组合表格形式，但是仍达不到标准三线表的要求，而且也无法计算统计量和P值。</p>
<ul>
<li>CLASS语句申明分类变量</li>
<li>VAR语句申明分析变量</li>
<li>TABLE语句设置表格形式，逗号“,”作为页、行、列等纬度的间隔符，星号“*”作为变量与其显示格式、统计关键字的关联符，括号“()”用来强制分组。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">ods tagsets.rtf file=&quot;table4.rtf&quot; style=journal3a;</div><div class="line">    title &quot;Table 1. Blood Pressure and Height by Sex&quot;;</div><div class="line">proc tabulate data=sashelp.heart;</div><div class="line">    class sex bp_status;</div><div class="line">    var height;</div><div class="line">    table sex, bp_status*(n rowpctn) height*(mean std);</div><div class="line">run;</div><div class="line">ods tagsets.rtf cloase;</div><div class="line"></div><div class="line">ods tagsets.rtf file=&quot;table5.rtf&quot; style=journal3a;</div><div class="line">    title &quot;Table 1. Blood Pressure and Height by Sex&quot;;</div><div class="line">proc tabulate data=sashelp.heart;</div><div class="line">    class sex bp_status;</div><div class="line">    var height;</div><div class="line">    table bp_status*(n colpctn) height*(mean std), sex;</div><div class="line">run;</div><div class="line">ods tagsets.rtf cloase;</div></pre></td></tr></table></figure>
<h3 id="PROC-REPORT"><a href="#PROC-REPORT" class="headerlink" title="PROC REPORT"></a>PROC REPORT</h3><p>纵款目无法用分组变量，横款目值没有缩进，统计变量之间没有连字符，无法获得检验统计量和P值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ods tagsets.rtf file=&quot;table6.rtf&quot; style=journal3a;</div><div class="line">ods escapechar=&apos;^&apos;;</div><div class="line">    title &quot;Table 6, Height and Weight by Gender&quot;;</div><div class="line">proc report data=sashelp.class nowd;</div><div class="line">    column sex height, (&quot;^R&apos;\brdrb\brdrs&apos;&quot; mean std) weight, (&quot;^R&apos;\brdrb\brdrs&apos;&quot; mean std);</div><div class="line">    define sex/group;</div><div class="line">    define height/analysis format=5.2;</div><div class="line">    define weight/analysis format=5.2;</div><div class="line">run;</div><div class="line">ods tagsets.rtf close;</div></pre></td></tr></table></figure>
<h3 id="完美三线图"><a href="#完美三线图" class="headerlink" title="完美三线图"></a>完美三线图</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line">/*1 血压状态数据整理*/</div><div class="line">/*1.1 获取频数百分比*/</div><div class="line">proc freq data=sashelp.heart; </div><div class="line">    table bp_status*sex /missing nopercent outpct out=desc1;</div><div class="line">run;</div><div class="line">data desc1;</div><div class="line">    set desc1;</div><div class="line">    length value $25;</div><div class="line">    value = compress(put(count, 6.)) || &apos; (&apos; || compress (put(pct_col, 4.1)) ||&apos;)&apos;;</div><div class="line">run;</div><div class="line"></div><div class="line">/*1.2 转置，性别作为列*/</div><div class="line">proc transpose data=desc1 out=desc1(drop=_name_) prefix=col;</div><div class="line">    var value;</div><div class="line">    by bp_status;</div><div class="line">    id sex;</div><div class="line">run;</div><div class="line"></div><div class="line">/*1.3 获取卡方检验P值*/</div><div class="line">proc freq data=sashelp.heart;</div><div class="line">    table bp_status*sex / norow nocol nopercent chisq;</div><div class="line">    output out=pvalue1(keep=p_pchi rename=(p_pchi=pvalue)) pchi;</div><div class="line">run;</div><div class="line"></div><div class="line">/*1.4 合并变量标签，描述数据，P值*/</div><div class="line">data dslabel1;</div><div class="line">    set pvalue1;</div><div class="line">    length label $ 85;</div><div class="line">    label=cats(&quot;^S=&#123;font_weight=bold&#125;&quot;, &quot;Blood presure status&quot;); /*RTF代码，加粗标签*/</div><div class="line">run;</div><div class="line"></div><div class="line">data merge1(keep=label col: pvalue);</div><div class="line">    set dslabel1 desc1;</div><div class="line">    if _n_&gt;1 then label=&quot;^&#123;nbspace 6&#125;&quot; || bp_status; /*RTF代码，增加缩进*/</div><div class="line">run;</div><div class="line"></div><div class="line">/*2 身高数据整理*/</div><div class="line">/*2.1 获取描述数据*/</div><div class="line">ods output summary=desc2;</div><div class="line">proc means data=sashelp.heart mean std;</div><div class="line">    class sex;</div><div class="line">    var height;</div><div class="line">run;</div><div class="line">data desc2(keep=sex meanstd);</div><div class="line">    set desc2;</div><div class="line">    meanstd = cats(put(height_mean,12.1), &quot;±&quot;, put(height_stddev,12.1));</div><div class="line">run;</div><div class="line"></div><div class="line">/*2.2 转置，性别作为列*/</div><div class="line">proc transpose data=desc2 out=desc2 prefix=col;</div><div class="line">    var meanstd;</div><div class="line">    id sex;</div><div class="line">run;</div><div class="line"></div><div class="line">/*2.3 判断方差齐性，获取t检验p值*/</div><div class="line">ods output equality=eql ttests=ttl;</div><div class="line">proc ttest data=sashelp.heart plots=non;</div><div class="line">    class sex;</div><div class="line">    var height;</div><div class="line">run;</div><div class="line">data pvalue2(keep=Probt rename=(Probt=Pvalue));</div><div class="line">    retain equV;</div><div class="line">    set eql ttl;</div><div class="line">    if ProbF&lt;0.05 then equV=0;</div><div class="line">    else equV=1;</div><div class="line">    if (equV=1 and variances=&quot;Equal&quot;) or (equV=0 and variances=&quot;Unequal&quot;);</div><div class="line">run;</div><div class="line"></div><div class="line">/*2.4 合并变量标签，描述数据，p值*/</div><div class="line">data merge2(keep=label col: pvalue);</div><div class="line">    length label $85;</div><div class="line">    merge desc2 pvalue2;</div><div class="line">    label=cats(&quot;^S=&#123;font_weight=bold&#125;&quot;, &quot;Height (in)&quot;); /*RTF代码，加粗标签*/</div><div class="line">run;</div><div class="line"></div><div class="line">/*3 合并数据*/</div><div class="line">data dsreport;</div><div class="line">    set merge:;</div><div class="line">run;</div><div class="line"></div><div class="line">/*4 Report输出*/</div><div class="line">options nodate nonumber missing=&apos; &apos;;</div><div class="line">ods tagsets.rtf file=&quot;table6.rtf&quot; style=journal3a;</div><div class="line">ods escapecha=&apos;^&apos;;</div><div class="line">    title &quot;Table 1.Blood Presure and Height by Sex&quot;;</div><div class="line">proc report data=dsreport nowd;</div><div class="line">    column label colfemale colmale pvalue;</div><div class="line">    define label / display &quot;Variables&quot;;</div><div class="line">    define colfemale / display &quot;Female&quot; right;</div><div class="line">    define colmale / display &quot;Male&quot; right;</div><div class="line">    define pvalue / analysis &quot;P Value&quot; f=pvalue6.4;</div><div class="line">run;</div><div class="line">footnote1 j=center height=10pt &quot;^&#123;nbspace&#125;Note: This is a demo&quot;;</div><div class="line">ods tagsets.rtf close;</div></pre></td></tr></table></figure>
<h2 id="一缕檀烟万佛名：宏中奥秘"><a href="#一缕檀烟万佛名：宏中奥秘" class="headerlink" title="一缕檀烟万佛名：宏中奥秘"></a>一缕檀烟万佛名：宏中奥秘</h2><p>###宏</p>
<p>SAS宏由宏语言和宏处理器构成。宏语言是与宏处理器沟通的语言。宏语言中以&amp;开头的是宏变量，以%开头的是SAS宏程序或宏函数。当SAS遇到&amp;或%开头的宏语言时，便触发宏处理器，执行宏操作。</p>
<h3 id="创建宏变量"><a href="#创建宏变量" class="headerlink" title="创建宏变量"></a>创建宏变量</h3><ul>
<li>%LET语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">/*文本*/</div><div class="line">%let bookname1=Romance of SAS Program;</div><div class="line">%let bookname2=SAS编程演义;</div><div class="line">%let address1=%str(Author%&apos;s address);</div><div class="line">%let address2=%nrstr(ShanghaiTech&amp;SMMU);</div><div class="line"></div><div class="line">/*数字*/</div><div class="line">%let phone1=13800137000;</div><div class="line">%let phone2=;</div><div class="line"></div><div class="line">/*算术表达式*/</div><div class="line">%let ex1=99+1;</div><div class="line">%let ex2=99.9+0.1;</div><div class="line"></div><div class="line">/*计算算术表达式*/</div><div class="line">%let ex3=%eval(99+1);</div><div class="line">%let ex4=%sysevalf(99.9+0.1);</div><div class="line"></div><div class="line">/*程序*/</div><div class="line">%let prg=%str(proc print data=sashelp.classr;run;);</div><div class="line"></div><div class="line">/*查看结果*/</div><div class="line">%put &amp;bookname1 &amp;bookname2 &amp;address1 &amp;address2 &amp;phone1 &amp;phone2 &amp;ex1 &amp;ex2 &amp;ex3 &amp;ex4 &amp;prg;</div></pre></td></tr></table></figure>
<ul>
<li>%GLOBAL申明一个全局宏变量（无法赋值），既可以在宏程序内部，也可以在外部。</li>
<li>%LOCAL申明一个局部宏变量（无法赋值），只能在宏程序内部。<ul>
<li>确保宏程序内部定义的宏变量不会因为同名重写全局宏变量的值</li>
<li>确保宏程序执行完毕后，这些宏变量立即消逝</li>
</ul>
</li>
<li>SQL里SELECT语句的INTO从句，可产生一个或一系列宏变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/*单个宏变量*/</div><div class="line">proc sql noprint;</div><div class="line">    select count(name) into:nname from sashelp.class;</div><div class="line">quit;</div><div class="line">%put &amp;nname;</div><div class="line"></div><div class="line">/*宏变量列表*/</div><div class="line">proc sql noprint;</div><div class="line">    select name into:namelist separated by &quot;,&quot; from sashelp.class;</div><div class="line">quit;</div><div class="line">%put &amp;namelist;</div></pre></td></tr></table></figure>
<ul>
<li>DATA步的SYMPUT和SYMPUTX（去除首尾空格）语句。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">/*单个宏变量*/</div><div class="line">data _null_;</div><div class="line">set sashelp.class end=last;</div><div class="line">if last then call symput(&apos;nname&apos;,_n_);</div><div class="line">run;</div><div class="line">%put &amp;nname;</div><div class="line"></div><div class="line">/*宏变量列表*/</div><div class="line">data _nuul_;</div><div class="line">set sashelp.calss;</div><div class="line">call symputx(cats(&apos;name&apos;,_n_),name);</div><div class="line">run;</div><div class="line">%put &amp;namelist;</div></pre></td></tr></table></figure>
<ul>
<li>宏程序的宏参数会创建局部宏变量</li>
<li>%WINDOWS语句</li>
<li>宏程序中的%DO语句</li>
<li>ODS OUTPUT语句的MATCH_ALL选项</li>
</ul>
<h3 id="宏符号表与作用域"><a href="#宏符号表与作用域" class="headerlink" title="宏符号表与作用域"></a>宏符号表与作用域</h3><p>宏符号表（Macro Symbol Table）存储着宏变量与其对应的值。</p>
<ul>
<li>全局宏符号表，SAS启动时，系统自动创建，其中存储的内容有：<ul>
<li>系统自带的宏变量和值</li>
<li>open code（宏程序外）环境下，用%LET语句创建的宏变量</li>
<li>宏程序定义中，用%GLOBAL申明的宏变量</li>
<li>DATA步中CALL SYMPUTX语句中申明了全局符号表</li>
<li>PROC SQL中SELECT语句的INTO从句创建的宏变量</li>
</ul>
</li>
<li>局部宏符号表，SAS执行宏程序时，系统自动创建，其中存储的内容有：<ul>
<li>由宏程序的宏参数创建的宏变量</li>
<li>宏程序中由%LET定义的宏变量，且在全局宏变量中没有同名宏变量</li>
<li>宏程序中由%LOCAL定义的宏变量</li>
</ul>
</li>
<li>判断是全局还是局部<ul>
<li>采用%PUT语句的选项_USER_、_LOCAL_、_GLOBAL_查看符号表</li>
<li>采用系统自带的宏函数%SYMLOCAL、%SYMGLOBAL进行判定</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">%macro testMacroVar(a=, b=);</div><div class="line">%put 所有自定义宏变量;</div><div class="line">%put _user_;</div><div class="line">%put 所有局部宏变量;</div><div class="line">%put _local_;</div><div class="line">%put 所有全局宏变量;</div><div class="line">%put _global_;</div><div class="line">%put sysver是否全局宏变量： %symglobl(sysver);</div><div class="line">%put a是否全局宏变量： %symglobl(a);</div><div class="line">%put b是否局部宏变量： %symlocal(b);</div><div class="line">%mend;</div><div class="line">%testMacroVar(a=Stats, b=Thinking)</div></pre></td></tr></table></figure>
<h3 id="掩蔽宏变量"><a href="#掩蔽宏变量" class="headerlink" title="掩蔽宏变量"></a>掩蔽宏变量</h3><p>掩蔽（masking）：将符号当作普通的文本对待，不使用其特殊含义，有的文档也称为引用（quoting）。</p>
<ul>
<li>需要掩蔽的符号：<ul>
<li>运算符：如+ - * / &lt; &gt; = ¬ ^ ~ |</li>
<li>助记符：如 AND OR NOT EQ NE LE LT GE GT IN</li>
<li>其他：bank , ; “ “ ‘ ’ ( ) #</li>
</ul>
</li>
<li>没有配对的符号，如 “ ‘ ( )，使用%B系列的函数掩蔽</li>
<li>宏触发器 &amp; %，使用%NR系列的引用函数</li>
<li>移除掩蔽主要发生在程序编译后、程序运行后、%UNQUOTE函数后</li>
</ul>
<h3 id="显示宏变量值"><a href="#显示宏变量值" class="headerlink" title="显示宏变量值"></a>显示宏变量值</h3><ul>
<li>系统选项SYMBOLGEN</li>
<li>%PUT语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">options symbolgen;</div><div class="line">%let title1=SAS编程演义;</div><div class="line">%let title2=数据整理与图表呈现;</div><div class="line">%let title=&amp;title1.:&amp;title2;</div><div class="line"></div><div class="line">options nosymbolgen;</div><div class="line">%let title1=SAS编程演义;</div><div class="line">%let title2=数据整理与图表呈现;</div><div class="line">%let title=&amp;title1.:&amp;title2;</div><div class="line">%put title1和title2合并后的title解析为：&amp;title;</div><div class="line"></div><div class="line">%put _all_; /*显示所有宏变量*/</div><div class="line">%put _automatic_; /*显示所有自动宏变量*/</div><div class="line">%put _user_; /*显示所有自定义宏变量*/</div><div class="line">%put _global_; /*显示所有全局宏变量*/</div><div class="line">%put _local_; /*显示所有局部宏变量*/</div></pre></td></tr></table></figure>
<h3 id="引用宏变量"><a href="#引用宏变量" class="headerlink" title="引用宏变量"></a>引用宏变量</h3><ul>
<li>直接引用</li>
</ul>
<p>如果是用宏变量给DATA步变量赋具体的值，需用引号引起来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">%let bookname2017=SAS编程演义;</div><div class="line">%let year=2017;</div><div class="line">data tmp;</div><div class="line">    name=&quot;&amp;bookname2017&quot;;</div><div class="line">    year=&amp;year;</div><div class="line">run;</div></pre></td></tr></table></figure>
<ul>
<li>间接引用</li>
</ul>
<p>SAS在解析时，会将两个连续的&amp;&amp;解析为一个&amp;，然后再次进行解析，知道&amp;全被解析完</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">%let bookname2017=SAS编程演义;</div><div class="line">%let year=2017;</div><div class="line">data tmp;</div><div class="line">    name=&quot;&amp;bookname&amp;&amp;year&quot;;</div><div class="line">run;</div><div class="line"></div><div class="line">%let L1=L2;</div><div class="line">%let L2=L3;</div><div class="line">%put &amp;L1; /*L2*/</div><div class="line">%put &amp;&amp;L1; /*&amp;L1 -&gt; L2*/</div><div class="line">%put &amp;&amp;&amp;L1; /*&amp;L2 -&gt; L3*/</div></pre></td></tr></table></figure>
<ul>
<li>合并宏变量与普通文本</li>
</ul>
<p>宏变量后面带一个点号，用以标识宏变量的结束</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">%let bookname2017=SAS编程演义;</div><div class="line">%let lib=sashelp;</div><div class="line">data class;</div><div class="line">    set &amp;lib..class;</div><div class="line">    bookname=&quot;&amp;bookname2017.:数据整理与图表呈现&quot;;</div><div class="line">run;</div></pre></td></tr></table></figure>
<h3 id="宏程序定义与调用"><a href="#宏程序定义与调用" class="headerlink" title="宏程序定义与调用"></a>宏程序定义与调用</h3><p><strong>%macro macro_name</strong> &lt;parameter_list&gt; &lt;/option(s)\&gt;</p>
<p>​    &lt;macro_text&gt;</p>
<p><strong>%mend</strong> &lt;macro_name&gt;;</p>
<p><strong>%macro_name</strong> &lt;parameter_list&gt;</p>
<ul>
<li><strong>macro_name</strong>：宏程序名称，需要符合SAS命名规范，不能以SYS、AF、DM开头，不能用SAS的保留字，以免冲突</li>
<li>parameter_list：宏参数，通过宏程序定义的局部变量，便于在宏文本中应用。参数通过逗号隔开<ul>
<li>位置宏参数：按位置顺序定义识别 &lt;positional-parameter-1&gt;&lt;, positional-parameter-2…&gt;</li>
<li>关键字宏参数：按名字=识别 &lt;keyword-parameter=&lt;value&gt; &lt;, keyword-parameter-2=&lt;value&gt; …&gt;&gt;</li>
</ul>
</li>
<li><em>option(s)</em>：比如加密选项secure，存储选项store</li>
<li>macro_text：宏文本是宏的主体，里面包括宏语句、DATA步语句、PROC语句等</li>
<li>宏参数不是必需的，位置宏参数和关键字宏参数可以混用，但位置宏参数必须在关键字宏参数前。</li>
<li>宏参数中如有特殊字符如&amp;、%、不配对的括号或引号、其他运算符等，需要做好宏变量的掩蔽。</li>
<li>%mend之后的宏程序名非必需。</li>
<li>调用宏程序时，末尾不需要分号结尾。</li>
</ul>
<h3 id="宏程序的存储加密"><a href="#宏程序的存储加密" class="headerlink" title="宏程序的存储加密"></a>宏程序的存储加密</h3><p>如果为了保护知识产权，想给他人使用宏程序但又不希望他人看到自己开发的宏程序源代码，可以将编译好的宏给别人，且设置为不显示宏的源代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">options mstored sasmstore=demo /*指定存储位置为demo永久库*/</div><div class="line">%macro printds(dataset, obs=5) / store;</div><div class="line">    options nomprint nosource; /*不显示源代码*/</div><div class="line">    proc print data=&amp;dataset(obs=&amp;obs);</div><div class="line">    run;</div><div class="line">%mend printds;</div><div class="line"></div><div class="line">options mstored sasmstore=demo;</div><div class="line">%printds(sashelp.class, obs=5)</div></pre></td></tr></table></figure>
<h3 id="IF-THEN-ELSE选择语句"><a href="#IF-THEN-ELSE选择语句" class="headerlink" title="%IF-%THEN-%ELSE选择语句"></a>%IF-%THEN-%ELSE选择语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">%macro printds(dataset, sex=F, obs=5,);</div><div class="line">    %if &amp;sex eq F %then %str(title &quot;First &amp;obs record for female&quot;;);</div><div class="line">    %else %if &amp;sex eq M %then %str(title &quot;First &amp;obs record for male&quot;;);</div><div class="line">    %else %str(title &quot;Wrong gender&quot;; %abort;);</div><div class="line">    proc print data=&amp;dataset(obs=&amp;obs where=(sex=&quot;&amp;sex&quot;));</div><div class="line">    run;</div><div class="line">%medn printde;</div><div class="line">%printde(sashelp.class,sex=M,obs=5)</div></pre></td></tr></table></figure>
<h3 id="DO组语句"><a href="#DO组语句" class="headerlink" title="%DO组语句"></a>%DO组语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">%do</div><div class="line">    语句；</div><div class="line">%end</div></pre></td></tr></table></figure>
<h3 id="DO循环语句"><a href="#DO循环语句" class="headerlink" title="%DO循环语句"></a>%DO循环语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">%macro importcsv;</div><div class="line">%do i=1 %to 100;</div><div class="line">    proc import out=csv&amp;i datafile=&quot;d:\data\casv&amp;i.csv&quot; dbms=csv replace;</div><div class="line">    run;</div><div class="line">%end;</div><div class="line">%mend;</div><div class="line"></div><div class="line">%importcsv</div></pre></td></tr></table></figure>
<h3 id="DO-WHILE语句"><a href="#DO-WHILE语句" class="headerlink" title="%DO-%WHILE语句"></a>%DO-%WHILE语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">%macro importcsv;</div><div class="line">%let i=1;</div><div class="line">%do %while(&amp;i&lt;=100);</div><div class="line">    proc import out=csv&amp;i datafile=&quot;d:\data\casv&amp;i.csv&quot; dbms=csv replace;</div><div class="line">    run;</div><div class="line">    %let i=&amp;i+1;</div><div class="line">%end;</div><div class="line">%mend;</div><div class="line"></div><div class="line">%importcsv</div></pre></td></tr></table></figure>
<h3 id="DO-UNTIL语句"><a href="#DO-UNTIL语句" class="headerlink" title="%DO-%UNTIL语句"></a>%DO-%UNTIL语句</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">%macro importcsv;</div><div class="line">%let i=1;</div><div class="line">%do %until(&amp;i&gt;100);</div><div class="line">    proc import out=csv&amp;i datafile=&quot;d:\data\casv&amp;i.csv&quot; dbms=csv replace;</div><div class="line">    run;</div><div class="line">    %let i=&amp;i+1;</div><div class="line">%end;</div><div class="line">%mend;</div><div class="line"></div><div class="line">%importcsv</div></pre></td></tr></table></figure>
<h3 id="宏函数"><a href="#宏函数" class="headerlink" title="宏函数"></a>宏函数</h3><table>
<thead>
<tr>
<th>类别</th>
<th>宏函数</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>字符宏函数</td>
<td>%index</td>
<td>返回字符串第一次出现的位置</td>
</tr>
<tr>
<td></td>
<td>%length</td>
<td>返回字符串长度</td>
</tr>
<tr>
<td></td>
<td>%scan %qscan</td>
<td>按字符串中的位置截取单词</td>
</tr>
<tr>
<td></td>
<td>%substr %qsubstr</td>
<td>截取子字符串</td>
</tr>
<tr>
<td></td>
<td>%upcase %qupcase</td>
<td>转为大写字符</td>
</tr>
<tr>
<td>计算函数</td>
<td>%eval</td>
<td>使用整数运算计算表达式结果</td>
</tr>
<tr>
<td></td>
<td>%sysevalf</td>
<td>使用浮点运算计算表达式结果</td>
</tr>
<tr>
<td>引用函数</td>
<td>%str</td>
<td>编译时掩蔽特殊字符及助记符</td>
</tr>
<tr>
<td></td>
<td>%nrstr</td>
<td>%str 外加宏触发器字符</td>
</tr>
<tr>
<td></td>
<td>%quote</td>
<td>执行时掩蔽特殊、助记、其他字符</td>
</tr>
<tr>
<td></td>
<td>%nrquote</td>
<td>%quote 外加宏触发器字符</td>
</tr>
<tr>
<td></td>
<td>%bquote</td>
<td>执行时掩蔽特殊、助记、其他字符和没有配对的符号</td>
</tr>
<tr>
<td></td>
<td>%nrbquote</td>
<td>%bquote 外加宏触发器字符</td>
</tr>
<tr>
<td></td>
<td>%superq</td>
<td>执行时掩蔽所有字符，且对结果保持</td>
</tr>
<tr>
<td></td>
<td>%unquote</td>
<td>执行时去掉所有特殊、助记字符的掩蔽</td>
</tr>
<tr>
<td>SYS系函数</td>
<td>%sysmacexect</td>
<td>返回宏执行状态</td>
</tr>
<tr>
<td></td>
<td>%sysmacexist</td>
<td>判断宏程序是否已经定义</td>
</tr>
<tr>
<td></td>
<td>%sysmexecdepth</td>
<td>返回宏嵌套的深度</td>
</tr>
<tr>
<td></td>
<td>%sysmexecname</td>
<td>返回指定宏嵌套的深度的宏名称</td>
</tr>
<tr>
<td></td>
<td>%sysfunc %qsysfunc</td>
<td>使用data步函数</td>
</tr>
<tr>
<td></td>
<td>%sysget</td>
<td>返回环境变量的值</td>
</tr>
<tr>
<td></td>
<td>%sysprod</td>
<td>判断SAS产品是否已经授权</td>
</tr>
<tr>
<td>SYM系函数</td>
<td>%symexist</td>
<td>判断宏变量是否已经存在</td>
</tr>
<tr>
<td></td>
<td>%symglobl</td>
<td>判断是否属于全局宏变量</td>
</tr>
<tr>
<td></td>
<td>%symlocal</td>
<td>判断是否属于局部宏变量</td>
</tr>
</tbody>
</table>
<h3 id="宏开发"><a href="#宏开发" class="headerlink" title="宏开发"></a>宏开发</h3><ol>
<li>硬代码实现：先不用任何宏代码，实现具体的任务</li>
<li>移除上一步中的硬代码，该用宏变量、宏参数，如有必要，增加宏语句如以及宏函数</li>
<li>宏代码测试优化：给宏变量赋值，逐步测试宏代码，优化宏代码。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <p class="site-author-name" itemprop="name">Yuanyi Wu</p>
            <p class="site-description motion-element" itemprop="description">朝闻道 夕死可矣</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/wu-yuanyi" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.facebook.com/yuanyi.wu.39" target="_blank" title="FB Page">
                  
                    <i class="fa fa-fw fa-facebook"></i>FB Page</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yuanyi Wu</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" href="https://hexo.io">Hexo</a></div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">Theme &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
